<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Salesforce Messaging + reCAPTCHA v3</title>
    <!-- Load reCAPTCHA v3 with your site key -->
    <script src="https://www.google.com/recaptcha/api.js?render=6Lc7zqwrAAAAAGQKQZsptTAJpLmZv5IQZE0auC_X" async defer></script>
  </head>
  <body>
    <h2>Messaging with reCAPTCHA v3</h2>

    <script type="text/javascript">
      function initEmbeddedMessaging() {
        console.log("Inside initEmbeddedMessaging()");
        try {
          embeddedservice_bootstrap.settings.language = 'en_US';

          window.addEventListener("onEmbeddedMessagingReady", () => {
            console.log("onEmbeddedMessagingReady fired");

            // Run reCAPTCHA only after API is ready
            grecaptcha.ready(function() {
              grecaptcha.execute('6Lc7zqwrAAAAAGQKQZsptTAJpLmZv5IQZE0auC_X', {action: 'submit'})
                .then(function(token) {
                  console.log("reCAPTCHA token:", token);

                  // Pass token to Salesforce hidden field
                  embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
                    "Subject": "From Website",
                    "reCAPTCHAToken__c": token
                  });
                })
                .catch(function(err) {
                  console.error("reCAPTCHA execution failed:", err);
                });
            });
          });

          embeddedservice_bootstrap.init(
            '00D5g00000KLfIK',   // ORG ID
            'Contact_Us_MIAW_deployement', // Deployment name
            'https://spabbaraju-231030-844-demo.my.site.com/ESWContactUsMIAWdeploy1699278255115',
            { scrt2URL: 'https://spabbaraju-231030-844-demo.my.salesforce-scrt.com' }
          );

        } catch (err) {
          console.error("Error loading Embedded Messaging:", err);
        }
      }
    </script>

    <!-- Salesforce Messaging bootstrap -->
    <script type="text/javascript"
      src="https://spabbaraju-231030-844-demo.my.site.com/ESWContactUsMIAWdeploy1699278255115/assets/js/bootstrap.min.js"
      onload="initEmbeddedMessaging()">
    </script>
  </body>
</html>
